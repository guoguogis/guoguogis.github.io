---
layout: post
title: 互联网地图多边形测面算法
date: 2012-05-03 14:07
author: guoguogis
comments: true
categories: [lessons]
tags: [GIS]
---
算法是ET写的，这里做个总结。

又是新的需求，要求画出多边形测量面积，单位是平发米或平方公里，要求在大比例尺下准度较高即可。

发现网上的解决方法有些要先进行投影转换，之后再计算平面坐标系的多边形面积。这需要与投影想关联，测量时还需获取响应的投影，而且还得把经纬度转换成投影坐标来计算，有些太麻烦了。

其实在地球上真实 的线面都是曲线和曲面，计算时不需要考虑投影，只需要考虑椭球体和基准面既可以了。为了减小计算量，我把椭球体去成半径为6378137m的椭球。

一开始我考虑的是用计算球星多边形面积的公式：

<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATkAAAAoCAIAAAAKfhosAAAErklEQVR4nO2c3aGDIAyFO5cDdR6n6TIOYx9sK2J+TqzGoDmPLfcKIR8JAfsYU6lUC3qc3YFUKgUpWU2l2lCymkq1oWQ1lTpJr+ej0vMlNE9WUyl/fTGd4Rz6TuE1WU2l/PV6Ph6Prh/Kz760crBehdV1OrG2xUU09N1Vh8bIbcQne9Hn8dwDr8aqmPDX+qUdG/72DM39ffbDjVgtIHJco77Wdmf1LnEV5a1ewj4TEzdc+XuOiyzlFX1Ht6sQi5OBeGtQVlC9J6tkrhGZVm0n056qlAYGdlP+9F8XNY9QecV8SiP1jqyyfq/sFs5T2I5tVMFpNQn8N4W8zIGyWuxM2NGA/0P23ruxKkxA0OB1NVJlCOYgJQzYxyRmVgWfEr0KAnW8G6vijscxvcIVdAH5S6JvzrDq3n2sVaw5MNlOArlsgIzkVqz+/IBsFZHV6wVVTVAkcqm0gc+QnQoiGfQ4mVV62xzJmb9CQJOt6lxlhASiOvv3smUxfc3QDp7OKCAppataYkjEOsI0k76ehoq7G8sqkWZgS945AlhVFsCAhyLIAlR75bf762U20MB4qTlj3XDdTq/LriQu3nJPxLgpIUPdXPp8zMw3wyp3gDH1LOCs626toBowBZbdYG4y9bjsf/GxPvBIMvSVnq/JcZcLFtUC8GGIVTBXY0CyLB0cq/ze/fW0oLphidM6rDxJPZjjWsQLq3pSPvTd/OUvX3713XIUAPMxZNqGkBO2jEpLcJd/hh/uSWaDipX8+SAt2x3DvWY3DqvwBiZO8DFOQmHragzxMgZSxvFiS9nqe7xaZ7m3VLcpHX83szM5MFQ5jyTNH9FVI1DssfkuvzOKlzEQ2lDZU+1DbdgM6xZgN9WrdqWHqy2VcSj0JH+kzIFWsrD78/Epg4lVYYDmcx+/bKh+oumvNftQGbDlQbpPCMnaEcwIZzbLngQHVpmE/WvAwVjlG9s5cGZ168UGxT5UBmyaZ70x5VVwIdsu7S7EYt4C58Mgq3JlPdZ6ZGGVH0Hwi09/mF6xz58ZMNA1JgAcRitybwm6UU0qSm1J3g3FRNXCqo5qsLF99M+1LGWHS722YksxNNOxTB4FK3jHcOMZXTRWxfsp0SKPodzCjz7wJcU/7S6jRI3buG6hV6OE2xj7uhR6Hzj2+ozmwMKbHQEHBgfWPTerXpKvJAx9p3VaHBr5343GUFxeAvIYWGtWh/ogvfg85qRPwurAOxRJPQU6Fx+AV+429F2IoSqXh4AfWBIXMtJwK2O8nuIjZFbFRPeYLLhilapzj+NIp/+RBN6FoKsAzY5Ka7WkmJ1cb2EXU7aDRHNsNQa0cVLe2drV2hWrdPAOHXwmwfeBfw3ge6FnyvL6kJDg/xRiVQKrGFs5Yjmpnrv97QDg9sH8rP0cbL1fJS0Z26NHMAJV63n4QY1I6MfqoVE4HfGCI/DKFNFEPLQwGYNjleq/9KjdbH+rd82bVANJjbOc6pzhyqnJanwlraXcEEpWD9KVWW2gCOYmx3lOVg/StVkdA3qOv5x/ZSecxZPVhhT5R3SO1SFnIIqS1YPUZvV6kyYfuhOtbiOO7UVXYTWVurqS1VSqDSWrqVQbegNDcNMhhJqGXgAAAABJRU5ErkJggg==" alt="" />

其中，Θ是多边形内角和，n是变数，R是球的半径。这个算法要求内角和，计算量太大，所以放弃了这个公式。

之后考虑到计算平面多边形面积的公式，因为在小范围内曲面近似为平面，而在大比例尺下用户测面的需求较少，公式为：

<img src="data:image/png;base64,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" alt="" width="559" height="49" />

其中x,y为所有多边形顶点的坐标，我这里就是顶点的经纬度。

该公式是通过三角形面积公式推导出来的，到此为止用经纬度计算了三角形面积公式，然后将单位转换成为平方米或平方公里，利用求弧长公式：

弧长= 角度*R*PI/180

这里需要注意的是纬度是经度是符合这个公式的，但是纬度并不相同，赤道处最大，两极点为0.

所以经度的曲线长度为：

长度 = （经度角度*R*PI/180)*cos(纬度)

转换在每两点中进行，例如(x1,y1),(x2,y2):

<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAH8AAABDCAIAAAA6Z02SAAAC9ElEQVR4nO2c26GsIAxFrcuCqMdqaMZi5n44CCrEBBKSuSf78/jKXic8nbh8XHpatAP403L6mhqlv2/r8lWI94MxNA8ZEmihOLgsy7rtrI8eon8N7Rp8eYw7aEadCQLkST6HO4sG6MeQ4jlJn9HF8IW+b6th+DGk1ICa6dMel/rpx5CxpviOP+zbajrfky6ZAeBP7vj7T5h+Cun1uQX+X2F/V/L6DP04MmCpiZGJfo59XY0Psi01+5fD2ogncfqCQ9MsNZL/HMLG7yxH/9r1/6Rqbg9bgwklT590br7AUkOpJNDLIIa0MK3fRyU/uL5R1MNumy7Jgiz9I0NCQPQ9t9WNrX7qlvz7Vp1B0C1I0j+DfD07L24YpnESKh3UO50uC3L0y8ZZa7mtS03SL9ZVJeaGtOjHUM2P65T52x/FenAm6ScH64pZMSrRL3fQLoegbbfe0Ofq7NTRUGfTz4zBHVl4qDZKPyU/Ji4D/X6vjNKnrGydPquIC1unzyjypoLTZ1PHZprTH4ygeB1Ej+Vn6UPTpkkafV9OsGCE/n09UGryv6F3p6/HghH6f1ROX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1NOX1Ni9L1iFCEZ+l4xSnsIJ/38+1mvGH1/DDP96BWjWEmPul4xirm1V4w25RWjqmokf8eP3Fp39opRQDW3/1/F6H2WZ6W5ECpGaRam9fvIksV8Q7kPgNBVqzt7BNZhQZY+vmK01onKfQKEKlTFaIcFSfr4ilH4KQZGjNIBaeYMW5CjXzbOWsvFT5f0c59YMVoItsBMP4ZqflAqRrGRzxWpYjTrxQIvfY6KUWTgs3XOHvjYM9NnqRgtz7aC/kOrGC0vAC1YfLtiD/2HurJFWjBH3yR62sIWb8EWfZPoaexJFizRH98zlBCpyyFa6KQvoIbLNIedHElXxSifhcn0n7tTtPkpo3rfl3NamEsfjHzuTkNvxSirBf8CvKacvqb+AfpCc8kTvmgWAAAAAElFTkSuQmCC" alt="" />

转换后就是：


代入公式即可得到单位为平方米的面积了。


补上实现代码：
```
public function calculateArea(lnglats: Vector.&lt;MLngLat&gt;):Number{
    var sum : Number = 0;
    var area :Number = 0;
    var metrePerDegree :Number = MConst.DEFAULT_EARTH_RADIUS * Math.PI / 180;
    for (var i : int = 0;i &lt; lnglats.length - 1; i++) {
    var ll1 : MLngLat = lnglats[i];
    var ll2 : MLngLat = lnglats[i + 1];
    var x1 : Number = ll1.lngX * metrePerDegree * Math.cos(ll1.latY * Math.PI / 180);
    var y1 : Number = ll1.latY * metrePerDegree;
    var x2 : Number = ll2.lngX * metrePerDegree * Math.cos(ll2.latY * Math.PI / 180);
    var y2 : Number = ll2.latY * metrePerDegree;
    sum += x1 * y2 - x2 * y1;
    }
    var xn : Number = lnglats[i].lngX * metrePerDegree * Math.cos(lnglats[i].latY * Math.PI / 180);
    var yn : Number = lnglats[i].latY * metrePerDegree;
    var xf : Number = lnglats[0].lngX * metrePerDegree * Math.cos(lnglats[0].latY * Math.PI / 180);
    var yf : Number = lnglats[0].latY * metrePerDegree;
    sum += xn * yf - xf * yn;
    area = 0.5 * Math.abs(sum);
    return area;
}
```
